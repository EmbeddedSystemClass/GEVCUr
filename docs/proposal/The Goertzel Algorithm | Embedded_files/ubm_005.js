function UBMCommentService(){this.loginSelector=".comments_login",this.postCommentSelector="#post-comments",this.mainSelector="#mainComment",this.counterSelector="#comment-counter",this.counterSelector2="#comment-counter-top",this.socialSelector="#socialCommentDiv",this.listSelector="#comments",this.replySelector="#subdiv",this.counterText="[COUNT] Comments",this.counterText2='<a href="#comments">[COUNT] Comments</a>',this.commentContainer='<div class="comments childcomments[LEVEL]" id="comment-[COMMENT_ID]" data-contentItemId="[CONTENTITEM_ID]"><div class="user"><img src="[USER_IMAGE]" width="75px" height="75px" alt="" /></div><div class="NNA_CommentTextSubBase Level[LEVEL]"><p>[USER_SCREENNAME]</p><p>[COMMENT_TEXT]</p><p>[COMMENT_DATE]</p></div><div class="clear"></div>[REPLY_CONTAINER]</div>',this.loginContainer='<p class="reply dark_blue"><a  href="javascript:void(0)" id="captureSignInLink" onclick="janrain.capture.ui.renderScreen(\'signIn\')">Reply</a></p>',this.replyContainer='<p class="reply dark_blue"><a href="javascript:_commentService.replyToComment([CONTENTITEM_ID], [COMMENT_ID],\'[CONTENTITEM_URL]\', [LEVEL])">Reply</a></p>',this.replyEntryContainer='<div id="subdiv"><p><textarea name="description" id="replyComment" cols="25" rows="4" class="postCommentTextarea" ></textarea></p><p><input name="submit" type="button" id="replySubmit" onclick="_commentService.postComment([CONTENTITEM_ID], $(\'#replyComment\').val(), [PARENT_COMMENT_ID], \'[CONTENTITEM_URL]\', [LEVEL])" value="Submit Comment" class="button no-float" /> <input type="button" id="cancel" value="Cancel" onclick="_commentService.cancelSubmit()" class="button no-float"/></p></div>',this.initialize=function(){var e=$(this.postCommentSelector),t=$(this.mainSelector);$(this.loginSelector).click(function(n){n.preventDefault(),e.slideToggle("slow"),t.focus()})},this.replyToComment=function(e,t,n,o){$("#replySubmit").attr("disabled","disabled");var r=this.replyEntryContainer.replace("[CONTENTITEM_ID]",e);r=(r=(r=r.replace("[PARENT_COMMENT_ID]",t)).replace("[CONTENTITEM_URL]",n)).replace("[LEVEL]",++o),$("#comment-"+t).find("#subdiv").remove(),$("#comment-"+t).append(r),$("#replyComment").focus()},this.isDoubleByte=function(e){for(var t=0,n=e.length;t<n;t++)if(e.charCodeAt(t)>255)return!0;return!1},this.postComment=function(e,t,n,o,r){var i=this,m=$(this.listSelector),c=$(this.mainSelector);null!=t&&""!=$.trim(t)?t.indexOf("<")>-1||t.indexOf(">")>-1?alert("Comment cannot contain < or >."):t.length>2e3?alert("Comment cannot be more than 2000 characters."):($("#submit").attr("disabled","disabled"),$("#replySubmit").attr("disabled","disabled"),this.AjaxCall({method:"PostComment",params:{contentItemId:e,comment:t,parentCommentId:n},callback:function(a){if(a.success||!a.url){i.adjustCounter(a.ActiveCommentCount);var l=i.populateCommentContainer(e,a.CommentId,o,a.UserImage,a.userId,a.UserScreenName,i.checkForLinks(t),i.formatDateFromComment(a),r,!0);$("#comment-"+n).length?($("#comment-"+n).after(l),$("#subdiv").remove()):m.prepend(l),$("#submit").removeAttr("disabled"),$("#replySubmit").removeAttr("disabled"),c.val(""),Omniture_trackComment()}else window.location=a.url+"?returnUrl="+encodeURIComponent(window.location)}})):alert("Comment cannot be blank")},this.loadComments=function(e,t){var n=this;this.AjaxCall({method:"LoadComments",params:{contentItemId:e},callback:function(o){n.commentsLoaded(o,e,t)}})},this.commentsLoaded=function(e,t,n){var o=this;$.each(e.Comments,function(){o.loadCommentTree(this,t,this.returnUrl)}),o.adjustCounter(e.ActiveCommentCount)},this.loadCommentTree=function(e,t,n){var o=this,r=o.populateCommentContainer(t,e.Id,n,e.UserImage,e.UserId,e.UserScreenName,o.checkForLinks(e.CommentText),o.formatDateFromComment(e),e.CommentLevel,e.AllowReply);$(this.listSelector).append(r),null!=e.CommentChildren&&$.each(e.CommentChildren,function(){o.loadCommentTree(this,t,n)})},this.populateCommentContainer=function(e,t,n,o,r,i,m,c,a,l){var s=this.commentContainer;s=a<5&&l?s.replace("[REPLY_CONTAINER]",this.replyContainer):a<5&&!l?(s=s.replace("[REPLY_CONTAINER]",this.loginContainer)).replace("[RETURN_URL]",n):s.replace("[REPLY_CONTAINER]","");var C=i;return"anonymous user"!==i&&(C='<a href="/user/'+escape(i)+'">'+i+"</a>"),s=(s=(s=(s=(s=(s=(s=s.replace(/\[LEVEL\]/g,a)).replace(/\[COMMENT_ID\]/g,t)).replace(/\[CONTENTITEM_ID\]/g,e)).replace(/\[USER_IMAGE\]/g,o)).replace(/\[USER_SCREENNAME\]/g,C)).replace(/\[COMMENT_TEXT\]/g,m)).replace(/\[COMMENT_DATE\]/g,c)},this.adjustCounter=function(e){e>0?($(this.counterSelector).html(this.counterText.replace("[COUNT]",e)),$(this.counterSelector2).html(this.counterText2.replace("[COUNT]",e)),$(this.socialSelector)&&$(this.socialSelector).show()):($(this.counterSelector).html(""),$(this.counterSelector2).html(""),$(this.socialSelector)&&$(this.socialSelector).hide())},this.cancelSubmit=function(){$(this.replySelector).remove()},this.formatDateFromComment=function(e){return _dateHelper.formatDate(e.CommentYear,e.CommentMonth,e.CommentDayOfMonth,e.CommentHour,e.CommentMinute)},this.checkForLinks=function(e){return e=e.replace(/[\n\r]/g," <br/> ")}}UBMCommentService.prototype=new UBMService("/Comment/");var _commentService=new UBMCommentService;function Omniture_trackComment(){}